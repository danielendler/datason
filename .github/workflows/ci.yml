# =============================================================================
# Datason v2 - Consolidated CI Pipeline
# =============================================================================
# This is the TEMPLATE for v2. It replaces 9 separate workflow files with 1.
# To activate: rename to ci.yml and delete the old workflow files.
# =============================================================================

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

env:
  UV_CACHE_DIR: /tmp/.uv-cache

jobs:
  # ===========================================================================
  # Job 1: Lint + Type Check + Architecture (fast, fails early)
  # ===========================================================================
  quality:
    name: Quality Gates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Ruff lint
        run: uv run ruff check datason/ tests/

      - name: Ruff format check
        run: uv run ruff format datason/ tests/ --check

      - name: Pyright type check
        run: uv run pyright --project .

      - name: Architecture - module size limits (500 lines)
        run: |
          violations=0
          while IFS= read -r line; do
            count=$(echo "$line" | awk '{print $1}')
            file=$(echo "$line" | awk '{print $2}')
            if [ "$count" -gt 500 ] && [ "$file" != "total" ]; then
              echo "::error file=$file::Module has $count lines (limit: 500)"
              violations=$((violations + 1))
            fi
          done < <(find datason -name "*.py" -exec wc -l {} +)
          if [ $violations -gt 0 ]; then
            echo "Found $violations module(s) exceeding 500 line limit"
            exit 1
          fi

      - name: Architecture - function length limits (50 lines)
        run: |
          uv run python -c "
          import ast, sys, pathlib
          violations = 0
          for path in sorted(pathlib.Path('datason').rglob('*.py')):
              try:
                  tree = ast.parse(path.read_text())
                  for node in ast.walk(tree):
                      if isinstance(node, (ast.FunctionDef, ast.AsyncFunctionDef)):
                          length = (node.end_lineno or 0) - node.lineno + 1
                          if length > 50:
                              print(f'::error file={path},line={node.lineno}::{node.name}() is {length} lines (limit: 50)')
                              violations += 1
              except SyntaxError:
                  pass
          if violations:
              print(f'Found {violations} function(s) exceeding 50 line limit')
              sys.exit(1)
          "

      - name: Security scan
        run: |
          uv run ruff check datason/ --select S
          uv run pip-audit

  # ===========================================================================
  # Job 2: Tests across Python versions
  # ===========================================================================
  test:
    name: Test (Python ${{ matrix.python-version }})
    needs: quality
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
        include:
          # Full test suite with all optional deps on 3.11 and 3.12
          - python-version: "3.11"
            extras: "--all-extras"
          - python-version: "3.12"
            extras: "--all-extras"
          # Core-only tests on 3.10 and 3.13
          - python-version: "3.10"
            extras: ""
          - python-version: "3.13"
            extras: ""
    steps:
      - uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install dependencies
        run: uv sync ${{ matrix.extras }}

      - name: Run tests
        run: |
          uv run pytest tests/unit/ \
            --cov=datason \
            --cov-report=xml \
            --cov-report=term-missing \
            -x --tb=short \
            --junitxml=junit-results.xml

      - name: Upload coverage
        if: matrix.python-version == '3.12'
        uses: codecov/codecov-action@v5
        with:
          files: coverage.xml
          flags: unittests
          fail_ci_if_error: false

  # ===========================================================================
  # Job 3: Benchmarks (on PR only, non-blocking)
  # ===========================================================================
  benchmark:
    name: Performance Benchmarks
    needs: quality
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run benchmarks
        run: |
          uv run pytest tests/benchmarks/ \
            --benchmark-only \
            --benchmark-sort=mean \
            --benchmark-json=benchmark-results.json \
            || echo "No benchmarks found yet - skipping"

      - name: Store benchmark result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark-results.json
          if-no-files-found: ignore

  # ===========================================================================
  # Job 4: Build validation
  # ===========================================================================
  build:
    name: Build Package
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.12

      - name: Build
        run: uv run python -m build

      - name: Check package
        run: uv run twine check dist/*

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
