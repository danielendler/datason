# =============================================================================
# Datason v2 — CI Pipeline
#
# Jobs:
#   1. quality   — lint, format, typecheck, architecture, security (fast gate)
#   2. test      — unit + integration across Python 3.10-3.13
#   3. benchmark — performance tracking on PRs (non-blocking)
#   4. build     — wheel + sdist + twine check
# =============================================================================

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  # ---------------------------------------------------------------------------
  # Quality gates — fast, fails early
  # ---------------------------------------------------------------------------
  quality:
    name: Quality Gates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Ruff lint
        run: uv run ruff check datason/ tests/

      - name: Ruff format
        run: uv run ruff format datason/ tests/ --check

      - name: Pyright
        run: uv run pyright --project .

      - name: Architecture — module size (500 lines)
        run: |
          uv run python -c "
          import pathlib, sys
          violations = 0
          for p in sorted(pathlib.Path('datason').rglob('*.py')):
              n = len(p.read_text().splitlines())
              if n > 500:
                  print(f'::error file={p}::{p} has {n} lines (limit: 500)')
                  violations += 1
          if violations:
              sys.exit(1)
          "

      - name: Architecture — function length (50 lines)
        run: |
          uv run python -c "
          import ast, sys, pathlib
          violations = 0
          for path in sorted(pathlib.Path('datason').rglob('*.py')):
              try:
                  tree = ast.parse(path.read_text())
                  for node in ast.walk(tree):
                      if isinstance(node, (ast.FunctionDef, ast.AsyncFunctionDef)):
                          length = (node.end_lineno or 0) - node.lineno + 1
                          if length > 50:
                              print(f'::error file={path},line={node.lineno}::{node.name}() is {length} lines (limit: 50)')
                              violations += 1
              except SyntaxError:
                  pass
          if violations:
              print(f'Found {violations} function(s) exceeding 50 line limit')
              sys.exit(1)
          "

      - name: Security — ruff S rules + pip-audit
        run: |
          uv run ruff check datason/ --select S
          uv run pip-audit

  # ---------------------------------------------------------------------------
  # Tests — matrix across Python versions
  # ---------------------------------------------------------------------------
  test:
    name: Test (Python ${{ matrix.python-version }})
    needs: quality
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.13"]
        extras: [""]
        include:
          - python-version: "3.11"
            extras: "--all-extras"
          - python-version: "3.12"
            extras: "--all-extras"
    steps:
      - uses: actions/checkout@v5

      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - run: uv python install ${{ matrix.python-version }}

      # Always install dev deps (pytest, etc.); optionally add all extras
      - name: Install dependencies
        run: |
          if [ -n "${{ matrix.extras }}" ]; then
            uv sync --all-extras
          else
            uv sync
          fi

      - name: Run tests
        run: |
          uv run pytest tests/unit/ tests/integration/ \
            --cov=datason \
            --cov-report=xml \
            --cov-report=term-missing \
            -x --tb=short \
            --junitxml=junit-results.xml

      - name: Upload coverage
        if: matrix.python-version == '3.12'
        uses: codecov/codecov-action@v5
        with:
          files: coverage.xml
          flags: unittests
          fail_ci_if_error: false

  # ---------------------------------------------------------------------------
  # Benchmarks — PRs only, non-blocking
  # ---------------------------------------------------------------------------
  benchmark:
    name: Benchmarks
    needs: quality
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v5

      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - run: uv python install 3.12

      - run: uv sync --all-extras

      - name: Run benchmarks
        run: |
          uv run pytest tests/benchmarks/ \
            --benchmark-only \
            --benchmark-sort=mean \
            --benchmark-json=benchmark-results.json

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: benchmark-results
          path: benchmark-results.json
          if-no-files-found: ignore

  # ---------------------------------------------------------------------------
  # Build — validate wheel + sdist
  # ---------------------------------------------------------------------------
  build:
    name: Build Package
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - run: uv python install 3.12

      - run: uv sync

      - name: Build wheel + sdist
        run: uv build

      - name: Check package metadata
        run: uvx twine check dist/*

      - uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
