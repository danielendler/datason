name: ðŸ“¦ Build & Publish to PyPI

on:
  # Trigger on new releases
  release:
    types: [published]

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      test_pypi:
        description: 'Publish to TestPyPI instead of PyPI'
        required: false
        default: false
        type: boolean

# Set explicit permissions for security
permissions:
  contents: read  # Needed to read repository contents
  id-token: write  # Needed for PyPI trusted publishing
  actions: read  # Needed to access artifacts

jobs:
  build:
    name: ðŸ—ï¸ Build Package
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: ðŸ“¦ Install Build Tools
      run: |
        python -m pip install --upgrade pip
        python -m pip install build twine

    - name: ðŸ” Verify Package Metadata
      run: |
        python -c "
        import tomllib
        with open('pyproject.toml', 'rb') as f:
            config = tomllib.load(f)
        print(f'Package: {config[\"project\"][\"name\"]}')
        print(f'Version: {config[\"project\"][\"version\"]}')
        print(f'Description: {config[\"project\"][\"description\"]}')
        "

    - name: ðŸ—ï¸ Build Package
      run: |
        # Clean any previous builds
        rm -rf dist/ build/ *.egg-info/

        # Build both wheel and source distribution
        python -m build

        # List what we built
        ls -la dist/

    - name: âœ… Verify Build
      run: |
        # Check package contents
        python -m zipfile -l dist/*.whl

        # Verify package can be installed
        python -m pip install dist/*.whl
        python -c "import datason; print(f'âœ… Package import successful: {datason.__version__ if hasattr(datason, \"__version__\") else \"unknown\"}')"

    - name: ðŸ” Run Package Checks
      run: |
        # Check distribution packages
        python -m twine check dist/*

    - name: ðŸ“¤ Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist-packages
        path: dist/
        retention-days: 7

  test-pypi:
    name: ðŸ§ª Publish to TestPyPI
    needs: build
    runs-on: ubuntu-latest
    if: github.event.inputs.test_pypi == 'true'
    environment: pypi  # Use the pypi environment for trusted publishing
    permissions:
      id-token: write  # For trusted publishing

    steps:
    - name: ðŸ“¥ Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: dist-packages
        path: dist/

    - name: ðŸ§ª Publish to TestPyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        repository-url: https://test.pypi.org/legacy/
        # Uses OIDC trusted publishing - no API tokens needed!

    - name: âœ… Verify TestPyPI Upload
      run: |
        echo "âœ… Package published to TestPyPI!"
        echo "ðŸ”— View at: https://test.pypi.org/project/datason/"
        echo "ðŸ“¦ Test install: pip install --index-url https://test.pypi.org/simple/ datason"

  pypi:
    name: ðŸš€ Publish to PyPI
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'release' && github.event.action == 'published'
    environment: pypi  # Use the pypi environment for trusted publishing
    permissions:
      id-token: write  # For trusted publishing

    steps:
    - name: ðŸ“¥ Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: dist-packages
        path: dist/

    - name: ðŸš€ Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      # Uses OIDC trusted publishing - no API tokens needed!

    - name: âœ… Verify PyPI Upload
      run: |
        echo "ðŸŽ‰ Package published to PyPI!"
        echo "ðŸ”— View at: https://pypi.org/project/datason/"
        echo "ðŸ“¦ Install: pip install datason"

    - name: ðŸ“¢ Create Release Summary
      run: |
        cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        ## ðŸŽ‰ Release Published Successfully!

        **Package**: `datason`
        **Version**: `${{ github.event.release.tag_name }}`
        **PyPI**: https://pypi.org/project/datason/

        ### ðŸ“¦ Installation
        ```bash
        pip install datason
        ```

        ### ðŸ”— Links
        - ðŸ“– [Documentation](https://datason.readthedocs.io)
        - ðŸ› [Report Issues](https://github.com/${{ github.repository }}/issues)
        - ðŸ’¬ [Discussions](https://github.com/${{ github.repository }}/discussions)
        EOF
